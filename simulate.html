<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=1920, initial-scale=1.0">
  <title>Aerial Screensaver — Simulator</title>
  <link rel="stylesheet" href="css/style.css">
  <style>
    video#sim-video {
      position: fixed;
      inset: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
      z-index: 1;
    }
    #sim-keys {
      position: fixed;
      top: 16px;
      right: 16px;
      z-index: 30;
      background: rgba(0,0,0,0.7);
      color: rgba(255,255,255,0.6);
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Helvetica, sans-serif;
      font-size: 13px;
      padding: 12px 16px;
      border-radius: 8px;
      line-height: 1.6;
      pointer-events: none;
      opacity: 1;
      transition: opacity 2s ease 5s;
    }
    #sim-keys.fade { opacity: 0; }
    #sim-keys kbd {
      background: rgba(255,255,255,0.15);
      padding: 1px 6px;
      border-radius: 3px;
      font-family: inherit;
    }
  </style>
</head>
<body>
  <video id="sim-video" muted></video>
  <img id="preload" src="" alt="">
  <div id="fade"></div>
  <div id="info">
    <div id="info-label"></div>
    <div id="info-description"></div>
  </div>
  <div id="menu">
    <div id="menu-title">Settings</div>
    <div id="menu-items"></div>
    <div id="menu-hint">ESC to close</div>
  </div>
  <div id="sim-keys">
    <strong>Keyboard</strong><br>
    <kbd>Enter</kbd> Menu &nbsp;
    <kbd>Space</kbd> Pause<br>
    <kbd>&rarr;</kbd> Next video &nbsp;
    <kbd>Esc</kbd> Close menu
  </div>

  <script src="js/catalog.js"></script>
  <script src="js/h264map.js"></script>
  <script>
  // ── Mock Samsung APIs ──
  // Wraps HTML5 <video> to match AVPlay interface
  // Uses H264 1080p URLs instead of HEVC 4K (browsers can't decode HEVC .mov)

  var simVideo = document.getElementById('sim-video');
  var simListener = {};

  function toBrowserUrl(url) {
    return (typeof H264_MAP !== 'undefined' && H264_MAP[url]) || url;
  }

  var webapis = {
    avplay: {
      _state: 'NONE',
      open: function (url) {
        simVideo.src = toBrowserUrl(url);
        this._state = 'IDLE';
      },
      setDisplayRect: function () {},
      setListener: function (l) { simListener = l; },
      prepareAsync: function (onSuccess, onError) {
        var self = this;
        simVideo.oncanplay = function () {
          simVideo.oncanplay = null;
          self._state = 'READY';
          if (onSuccess) onSuccess();
        };
        simVideo.onerror = function () {
          simVideo.onerror = null;
          if (onError) onError();
        };
        simVideo.load();
      },
      play: function () {
        simVideo.play();
        this._state = 'PLAYING';
      },
      pause: function () {
        simVideo.pause();
        this._state = 'PAUSED';
      },
      stop: function () {
        simVideo.pause();
        simVideo.removeAttribute('src');
        this._state = 'NONE';
      },
      close: function () {
        this._state = 'NONE';
      },
      getState: function () {
        return this._state;
      }
    }
  };

  // Buffering simulation
  simVideo.addEventListener('waiting', function () {
    if (simListener.onbufferingstart) simListener.onbufferingstart();
  });
  simVideo.addEventListener('playing', function () {
    if (simListener.onbufferingcomplete) simListener.onbufferingcomplete();
  });
  simVideo.addEventListener('ended', function () {
    if (simListener.onstreamcompleted) simListener.onstreamcompleted();
  });
  simVideo.addEventListener('error', function () {
    if (simListener.onerror) simListener.onerror();
  });
  simVideo.addEventListener('timeupdate', function () {
    if (simListener.oncurrentplaytime) simListener.oncurrentplaytime(simVideo.currentTime * 1000);
  });

  // Mock tizen namespace
  var tizen = {
    tvinputdevice: {
      registerKey: function () {}
    },
    application: {
      getCurrentApplication: function () {
        return {
          exit: function () {
            document.title = 'Aerial — [exited]';
            document.body.textContent = '';
            document.body.style.background = '#000';
          }
        };
      }
    }
  };

  // ── Remap browser keys to Tizen keyCodes ──
  // Space → PlayPause (10252), Escape → Back (10009)
  document.addEventListener('keydown', function (e) {
    if (e.keyCode === 32) { // Space → PlayPause
      e.preventDefault();
      var ev = new KeyboardEvent('keydown', {keyCode: 10252, bubbles: true});
      document.dispatchEvent(ev);
      e.stopImmediatePropagation();
      return;
    }
    if (e.keyCode === 27) { // Escape → Back
      e.preventDefault();
      var ev2 = new KeyboardEvent('keydown', {keyCode: 10009, bubbles: true});
      document.dispatchEvent(ev2);
      e.stopImmediatePropagation();
      return;
    }
  }, true);

  // Fade the keyboard help after first interaction
  document.addEventListener('keydown', function () {
    var keys = document.getElementById('sim-keys');
    if (keys) keys.classList.add('fade');
  }, {once: true});
  </script>
  <script src="js/main.js"></script>
</body>
</html>
